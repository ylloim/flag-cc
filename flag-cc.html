<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="./countries-data.html">

<dom-module id="flag-cc">
  <template>
    <style>
      :host {
        display: inline-block;
        min-height: 5px;
        min-width: 5px;
        position: relative;
      }
      iron-image {
        height: 100%;
        width: 100%;
      }
      :host([flag-type=currency]){
        max-height: 13px;
        max-width: 22px;
        border: 1px solid #333333;
      }

      #overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0.5;
        /* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#ffffff+0,ffffff+100&1+0,0+100;White+to+Transparent */
        background: -moz-linear-gradient(top, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); /* FF3.6-15 */
        background: -webkit-linear-gradient(top, rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to bottom, rgba(255,255,255,1) 0%,rgba(255,255,255,0) 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#ffffff', endColorstr='#00ffffff',GradientType=0 ); /* IE6-9 */
      }
    </style>
    <countries-data data="{{_countries}}"></countries-data>

    <iron-image sizing="cover" title$="[[_flag_title]]" src$="[[_flag_src]]"></iron-image>
    <div id="overlay"></div>
  </template>

  <script>
    /**
     * `flag-cc`
     * A simple component that displays the flag and some information about the currency and the country.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class FlagCc extends Polymer.Element {
      static get is() { return 'flag-cc'; }
      static get properties() {
        return {
          code: {
            type: String
          },
          currency: {
            type: String
          },
          // Outputed country
          country: {
            type: Object,
            notify: true,
            readOnly: true
          },
          _countries: {
            type: Object
          },
          _flag_src: {
            type: String
          },
          _flag_title: {
            type: String
          },
          _debouncer: {
            type: Number
          },
          flagType: {
            type: String,
            reflectToAttribute: true
          }
        };
      }

      static get observers(){
        return [
          "_updateFlag(_countries, code, currency)"
        ]
      }

      _updateFlag( _countries, code, currency) {
        if(!_countries || (!code && !currency)){ return; }
        if( this._debouncer) { clearTimeout(this._debouncer); }
        this._debouncer = setTimeout( () => {
          var item = null;
          var _flag_src = "";
          var _flag_type = null;
          if(code) {
            code = code.toUpperCase();
            if(code.length == 2) {
              item = _countries.byCode2[code];
            } else if (code.length == 3){
              item = _countries.byCode3[code];
            } else {
              console.warn("FLAG-CC> code length should be either 2 or 3", code);
            }
            if(item) {
              _flag_src = "flags/countries/"+item.flag;
            } else {
              console.warn("The item was not found for code", code);
            }
            _flag_type = "country";
          } else if(currency) {
            currency = currency.toUpperCase();
            item = _countries.currencies[currency];
            if(item) {
              _flag_src = "flags/currencies/"+item.flag;
            } else {
              console.warn("The item was not found for currency", currency);
            }
            _flag_type = "currency";
          }
          if(item) {
            this._flag_src = this.resolveUrl(_flag_src);
            this._flag_title = code ? item.name : item.currencyFull;
            this.countries = item;
            this.flagType = _flag_type;
          }
        }, 1);
      }
    }

    window.customElements.define(FlagCc.is, FlagCc);
  </script>
</dom-module>
